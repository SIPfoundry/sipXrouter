<?xml version="1.0" encoding="UTF-8" ?>
<!--  -->

<project name="preflight" default="launcher" basedir="." xmlns:cpptasks="antlib:org.sf.net.antcontrib.cpptasks">

  <patternset id="test.classes" excludes="**"/>
  <property name="top.build.dir" value="${basedir}/.."/>
  <property name="build.dir" value="${top.build.dir}/preflight"/>
  <property name="one-jar.dist.dir" value="${build.dir}/dist"/>
  <property name="compiler" value="${cc}"/>
  <property name="preflight.lib.dir" value="${lib.dir}/preflight"/>

  <import file="ant-targets.xml"/>

  <path id="base.path" >
    <pathelement location="${dnsjava.jar}"/>
    <pathelement location="${CommonsCli.jar}"/>
    <pathelement location="${CommonsNet.jar}"/>
    <pathelement location="${JainSipApi.jar}"/>
    <pathelement location="${JainSipRi.jar}"/>
    <pathelement location="${swt.jar}"/>
    <pathelement location="${junit.jar}"/>
    <pathelement location="${log4j.jar}"/>
  </path>
  <property name="classpath" refid="base.path" />

  <!-- J A R -->
  <target name="jar" depends="compile" description="create jar file" >
    <taskdef name="one-jar" classname="com.simontuffs.onejar.ant.OneJarTask" classpath="${one-jar.jar}" onerror="report"/>
    <one-jar destfile="${build.dir}/dist/preflight.jar" manifest="${src.dir}/preflight.mf" >
      <main>
        <fileset dir="${classes.dir}" >
          <include name="**/*.class" />
        </fileset>
      </main>
      <lib>
        <fileset file="${dnsjava.jar}" />
        <fileset file="${CommonsCli.jar}" />
        <fileset file="${CommonsNet.jar}" />
        <fileset file="${JainSipApi.jar}" />
        <fileset file="${JainSipRi.jar}" />
        <fileset file="${swt.jar}" />
        <fileset file="${log4j.jar}" />
      </lib>
      <binlib>
        <fileset dir="${src.dir}/lib" >
          <include name="*.dll" />
        </fileset>
      </binlib>
      <fileset dir="${src.dir}">
        <include name="icons/**"/>
      </fileset>
    </one-jar>
  </target>

  <!-- L A U N C H E R -->
  <target name="launcher" depends="windows-launcher, posix-launcher" description="create native launchers" />

  <target name="windows-launcher" depends="jar" description="create native windows launcher" >
    <taskdef name="launch4j" classname="net.sf.launch4j.ant.Launch4jTask" classpath="${launch4j.jar}:${xstream.jar}" />
    <copy file="${src.dir}/Preflight.xml.in" tofile="${build.dir}/dist/Preflight.xml"/>
    <replace file="${build.dir}/dist/Preflight.xml">
      <replacefilter token="@src.dir@" value="${src.dir}"/>
      <replacefilter token="@build.dir@" value="${build.dir}"/>
    </replace>
    <launch4j configFile="${build.dir}/dist/Preflight.xml" />
  </target>

  <target name="posix-launcher" depends="jar" description="create native *nix command line launcher" >
    <taskdef resource="cpptasks.tasks" classpath="${cpptasks.jar}"/>
    <typedef resource="cpptasks.types" classpath="${cpptasks.jar}"/>
    <cc outfile="${build.dir}/dist/preflight">
      <fileset dir="${src.dir}/src/main/native/posix" includes="*.c"/>
      <defineset>
        <define name="JAVA" value='"${java}"'/>
        <define name="SIPX_LIBDIR" value='"${preflight.lib.dir}"'/>
      </defineset>
    </cc>
  </target>

  <!-- I N S T A L L -->
  <target name="install">
    <!-- BINARIES/LIB/SCRIPTS -->
    <mkdir dir="${dest.dir}${preflight.lib.dir}"/>
    <copy file="${build.dir}/dist/preflight.jar" todir="${dest.dir}${preflight.lib.dir}"/>

    <copy file="${build.dir}/dist/preflight" tofile="${dest.dir}${bin.dir}/preflight"/>
    <chmod file="${dest.dir}${bin.dir}/preflight" perm="ugo+x" />
    
  </target>

  <target name="uninstall">
    <delete file="${dest.dir}${bin.dir}/preflight"/>
    <delete file="${dest.dir}${preflight.lib.dir}/preflight.jar"/>
  </target>

</project>
