#!/bin/bash

if [ -f @SIPX_CONFDIR@/domain-config ]; then
  if [ $# -eq 0 ]; then
    exit 0
  fi
fi

if [ ! -f @SIPX_CFDATA@/defaults/location_id ]; then
    echo "1" > @SIPX_CFDATA@/defaults/location_id
fi

cat > @SIPX_CFDATA@/defaults/primary.cfdat <<EOF
+postgres
+primary
EOF

TempDir=@SIPX_VARDIR@/temp/cert-temp
test -d ${TempDir} && rm -rf ${TempDir}
mkdir -p $TempDir
cd $TempDir
Fqdn=`hostname -f`
cat > SSL_DEFAULTS << EOF
countryName="US"
stateOrProvinceName="AnyState"
localityName="AnyTown"
organizationName="${Fqdn}"
organizationalUnitName="IT"
caName="ca.${Fqdn}"
caEmail="root@${Fqdn}"
sipDomainName="${Fqdn}"
server="${Fqdn}"
serverEmail="root@${Fqdn}"
EOF
@SIPX_BINDIR@/ssl-cert/gen-ssl-keys.sh -d -p SSL_DEFAULTS
@SIPX_BINDIR@/ssl-cert/install-cert.sh

SharedSecret=`head -c 18 /dev/urandom | base64`
cat > @SIPX_CONFDIR@/domain-config.tmp <<EOF
SIP_DOMAIN_NAME : ${Fqdn}
SIP_DOMAIN_ALIASES : ${Fqdn}
SIP_REALM : ${Fqdn}
SHARED_SECRET : ${SharedSecret}
DEFAULT_LANGUAGE : en
SUPERVISOR_PORT : 8092
CONFIG_HOSTS : ${Fqdn}
EOF
mv @SIPX_CONFDIR@/domain-config.tmp @SIPX_CONFDIR@/domain-config
