SF_REMOTE_DIR = /vol/download/pub/sipXecs
SF_SSH_DOWNLOAD = download@download.sipfoundry.org

TARGET_DISTRO = $(firstwork $(subst _, ,$(TARGET_PLATFORM)))
lowercase = $(echo $(1) | tr [A-Z] [a-z])

BASE_ARCH = \
	i386 \
	x86_64

help.sipfoundry-publish = Push repo for $(TARGET_PLATFORM) version @PACKAGE_VERSION@ to sipfoundry download directory
sipfoundry-publish : check-repo $(TARGET_PLATFORM)-sipfoundry-publish $(TARGET_DISTRO)-repofile

%.rpmlist :
	! test -f $@.tmp || rm $@.tmp
	@for f in $(shell find repo/$(TARGET_PLATFORM) -name '*.rpm'); do \
	  echo -n `dirname $$f`/ >> $@.tmp; \
	  rpm -qi -p $$f 2>/dev/null | head -1 | awk '{print $$3}' >>$@.tmp; \
	done
	sort $@.tmp > $@
	rm $@.tmp

# Compare the list that was first uploaded from this machine with the new list you're uploading. If there are
# any differences to the packages that are uploaded, complain and abort
check-repo : repo/$(TARGET_PLATFORM).expected.rpmlist
	$(MAKE) -B repo/$(TARGET_PLATFORM).actual.rpmlist
	@if ! diff -u repo/$(TARGET_PLATFORM).expected.rpmlist repo/$(TARGET_PLATFORM).actual.rpmlist; then \
	  echo "differences in expected rpms. Please check"; exit 1; \
	else \
	  echo "no differences found"; \
	fi

create-destination-dir :
	ssh $(SF_SSH_DOWNLOAD) "test -d $(SF_REMOTE_DIR)/@PACKAGE_VERSION@/$(TARGET_PLATFORM) || mkdir -p $(SF_REMOTE_DIR)/@PACKAGE_VERSION@/$(TARGET_PLATFORM)"

CentOS_5-sipfoundry-publish : create-destination-dir
	rsync --delete --archive --no-owner --verbose repo/$(TARGET_PLATFORM)/ $(SF_SSH_DOWNLOAD):$(SF_REMOTE_DIR)/@PACKAGE_VERSION@/$(TARGET_PLATFORM)/
	$(foreach ARCH,$(BASE_ARCH), \
	  ssh $(SF_SSH_DOWNLOAD) "cd $(SF_REMOTE_DIR)/@PACKAGE_VERSION@/$(TARGET_PLATFORM)/$(ARCH); createrepo .";)

# Assumes this machine is Fedora 11 or 12 and that Fedora 11/12 repo metadata is forwards and/or backwards compatible
Fedora_12-sipfoundry-publish Fedora_11-sipfoundry-publish : create-destination-dir
	$(foreach ARCH,$(BASE_ARCH), \
	  createrepo repo/$(TARGET_PLATFORM)/$(ARCH);)
	rsync --delete --archive --no-owner --verbose repo/$(TARGET_PLATFORM)/ $(SF_SSH_DOWNLOAD):$(SF_REMOTE_DIR)/@PACKAGE_VERSION@/$(TARGET_PLATFORM)/

Fedora-repofile CentOS-repofile :
	echo "$$repofile" | ssh $(SF_SSH_DOWNLOAD) \
	  'cat > $(SF_REMOTE_DIR)/test-sipxecs-@PACKAGE_VERSION@-$(call lowercase,$(TARGET_DISTRO)).repo'

define repofile =
[sipXecs]
name=sipXecs software for $(TARGET_DISTRO) $$releasever - $$basearch
baseurl=http://download.sipfoundry.org/pub/sipXecs/@PACKAGE_VERSION@/$(TARGET_DISTRO)_$$releasever/$$basearch
gpgcheck=0
endef
export repofile